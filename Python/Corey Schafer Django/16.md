# Python Django Tutorial: Full-Featured Web App Part 13 - Using AWS S3 for File Uploads

## Key Insights and Steps

### Introduction
- **Objective**: Use Amazon S3 for file storage instead of the local file system.
- **Benefits**: Cost-effective, scalable, secure, and good performance.

### Prerequisites and Corrections
- **Correction in `models.py`**: Ensure the `save` method in `users/models.py` accepts positional (`args`) and keyword arguments (`kwargs`).
    ```python
    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
    ```

### Setting Up AWS S3
- **Create AWS Account**: Sign up at [aws.amazon.com](https://aws.amazon.com).
- **Create S3 Bucket**:
  1. Go to the S3 service in the AWS Management Console.
  2. Click "Create bucket", name it (e.g., `django-blog-files`), and accept default settings.
- **Set Bucket Permissions**:
  1. Go to the bucket's permissions tab.
  2. Configure Cross-Origin Resource Sharing (CORS) with the following policy:
    ```json
    {
        "CORSRules": [
            {
                "AllowedOrigins": ["*"],
                "AllowedMethods": ["GET", "POST"],
                "MaxAgeSeconds": 3000
            }
        ]
    }
    ```

### Creating IAM User
- **Create IAM User**:
  1. Open the IAM service.
  2. Click "Add user", name it (e.g., `django_user`), and select "Programmatic access".
  3. Attach the `AmazonS3FullAccess` policy.
  4. Note the Access Key ID and Secret Access Key.

### Environment Variables
- **Set Environment Variables**:
  - Use environment variables for sensitive information.
  - Add the following to `.bash_profile` or equivalent:
    ```bash
    export AWS_ACCESS_KEY_ID='your_access_key_id'
    export AWS_SECRET_ACCESS_KEY='your_secret_access_key'
    export AWS_STORAGE_BUCKET_NAME='django-blog-files'
    ```

### Updating Django Settings
- **Install Required Packages**:
  ```bash
  pip install boto3 django-storages
  ```
- **Update `settings.py`**:
  1. Add `storages` to `INSTALLED_APPS`:
    ```python
    INSTALLED_APPS = [
        ...
        'storages',
    ]
    ```
  2. Configure AWS settings:
    ```python
    import os

    AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
    AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
    AWS_STORAGE_BUCKET_NAME = os.environ.get('AWS_STORAGE_BUCKET_NAME')

    AWS_S3_FILE_OVERWRITE = False
    AWS_DEFAULT_ACL = None
    DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
    ```

### Adjusting Image Resizing
- **Remove Image Resizing in `models.py`**:
  - Comment out or remove the `save` method related to image resizing.

### Uploading Existing Files to S3
- **Upload Existing Files**:
  1. Open the S3 bucket in the AWS Management Console.
  2. Drag and drop existing files (e.g., profile pictures) into the bucket.

### Testing
- **Run Django Server**:
  ```bash
  python manage.py runserver
  ```
- **Verify File Storage**:
  - Check that uploaded files are stored and served from S3.

## Summary
- Set up AWS S3 for scalable file storage.
- Create an S3 bucket and IAM user with appropriate permissions.
- Configure Django to use S3 for file storage.
- Ensure environment variables are securely managed.
- Remove image resizing logic for S3 compatibility.
- Verify functionality by running the Django server and uploading files.

### Key Code Snippets
- **Correction in `models.py`**:
    ```python
    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
    ```
- **Django Settings**:
    ```python
    import os

    AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
    AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
    AWS_STORAGE_BUCKET_NAME = os.environ.get('AWS_STORAGE_BUCKET_NAME')

    AWS_S3_FILE_OVERWRITE = False
    AWS_DEFAULT_ACL = None
    DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
    ```
- **Environment Variables**:
    ```bash
    export AWS_ACCESS_KEY_ID='your_access_key_id'
    export AWS_SECRET_ACCESS_KEY='your_secret_access_key'
    export AWS_STORAGE_BUCKET_NAME='django-blog-files'
    ```